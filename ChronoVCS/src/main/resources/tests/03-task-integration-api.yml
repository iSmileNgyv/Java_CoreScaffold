# Task Integration API Tests
# Tests CRUD operations for Task Integration management

env:
  BASE_URL: "http://localhost:8081"

variables:
  testEmail: "admin@chronovcs.com"
  testPassword: "admin123"
  jiraIntegrationName: "Test JIRA Integration"
  genericIntegrationName: "Test Generic Integration"

tests:
  # ===== Setup: Create test user via database =====
  - name: "Create test user via database"
    type: BASH
    bash:
      command: |
        PGPASSWORD=chronovcs_password psql -h localhost -p 5432 -U chronovcs_user -d chronovcs -c "
        INSERT INTO chronovcs_users (email, password_hash, full_name, created_at, updated_at)
        VALUES (
          '{{testEmail}}',
          '\$2a\$10\$N9qo8uLOickgx2ZMRZoMyeIjZAgcfl7p92ldGxad68LJZdL17lhWy',
          'Test Admin',
          NOW(),
          NOW()
        )
        ON CONFLICT (email) DO NOTHING;
        "
    continueOnError: true
    expect:
      status: 0

  # ===== Authentication =====
  - name: "Login to get access token"
    type: REST
    rest:
      url: "{{BASE_URL}}/api/auth/login"
      method: POST
      headers:
        Content-Type: "application/json"
      body:
        email: "{{testEmail}}"
        password: "{{testPassword}}"
    extract:
      accessToken: "$.accessToken"
      refreshToken: "$.refreshToken"
    expect:
      status: 200

  # ===== Create JIRA Integration =====
  - name: "Create JIRA task integration"
    type: REST
    rest:
      url: "{{BASE_URL}}/api/v1/task-integrations"
      method: POST
      headers:
        Content-Type: "application/json"
        Authorization: "Bearer {{accessToken}}"
      body:
        type: "JIRA"
        name: "{{jiraIntegrationName}}"
        enabled: true
        jiraUrl: "https://your-domain.atlassian.net"
        jiraAuthType: "BEARER"
        jiraApiToken: "test-api-token-123"
        versionMappings:
          - fieldName: "issuetype"
            fieldValue: "Bug"
            versionType: "PATCH"
          - fieldName: "issuetype"
            fieldValue: "Story"
            versionType: "MINOR"
          - fieldName: "issuetype"
            fieldValue: "Epic"
            versionType: "MAJOR"
    extract:
      jiraIntegrationId: "$.id"
      jiraIntegrationCreatedAt: "$.createdAt"
    expect:
      status: 200
      jsonContains:
        type: "JIRA"
        name: "{{jiraIntegrationName}}"
        enabled: true

  # ===== List All Integrations =====
  - name: "Get all task integrations"
    type: REST
    rest:
      url: "{{BASE_URL}}/api/v1/task-integrations"
      method: GET
      headers:
        Authorization: "Bearer {{accessToken}}"
    expect:
      status: 200

  # ===== Get Specific Integration =====
  - name: "Get JIRA integration by ID"
    type: REST
    rest:
      url: "{{BASE_URL}}/api/v1/task-integrations/{{jiraIntegrationId}}"
      method: GET
      headers:
        Authorization: "Bearer {{accessToken}}"
    expect:
      status: 200
      jsonContains:
        id: "{{jiraIntegrationId}}"
        type: "JIRA"
        name: "{{jiraIntegrationName}}"

  # ===== Update Integration =====
  - name: "Update JIRA integration name"
    type: REST
    rest:
      url: "{{BASE_URL}}/api/v1/task-integrations/{{jiraIntegrationId}}"
      method: PUT
      headers:
        Content-Type: "application/json"
        Authorization: "Bearer {{accessToken}}"
      body:
        type: "JIRA"
        name: "Updated JIRA Integration"
        enabled: false
        jiraUrl: "https://updated-domain.atlassian.net"
        jiraAuthType: "BEARER"
        jiraApiToken: "updated-token-456"
        versionMappings:
          - fieldName: "issuetype"
            fieldValue: "Bug"
            versionType: "PATCH"
    expect:
      status: 200
      jsonContains:
        id: "{{jiraIntegrationId}}"
        name: "Updated JIRA Integration"
        enabled: false

  # ===== Create GENERIC Integration =====
  - name: "Create GENERIC task integration"
    type: REST
    rest:
      url: "{{BASE_URL}}/api/v1/task-integrations"
      method: POST
      headers:
        Content-Type: "application/json"
        Authorization: "Bearer {{accessToken}}"
      body:
        type: "GENERIC"
        name: "{{genericIntegrationName}}"
        enabled: true
        apiUrl: "https://api.custom-system.com/tasks"
        httpMethod: "POST"
        headers:
          - key: "Authorization"
            value: "Bearer custom-token"
          - key: "Content-Type"
            value: "application/json"
        request:
          bodyTemplate: "{\"taskIds\": [{taskIds}]}"
        response:
          taskIdPath: "$.data[*].id"
          taskTypePath: "$.data[*].type"
          taskTitlePath: "$.data[*].title"
          taskDescriptionPath: "$.data[*].description"
        versionMappings:
          - fieldName: "type"
            fieldValue: "bug"
            versionType: "PATCH"
          - fieldName: "type"
            fieldValue: "feature"
            versionType: "MINOR"
    extract:
      genericIntegrationId: "$.id"
    expect:
      status: 200
      jsonContains:
        type: "GENERIC"
        name: "{{genericIntegrationName}}"
        enabled: true

  # ===== Verify Generic Integration =====
  - name: "Get GENERIC integration by ID"
    type: REST
    rest:
      url: "{{BASE_URL}}/api/v1/task-integrations/{{genericIntegrationId}}"
      method: GET
      headers:
        Authorization: "Bearer {{accessToken}}"
    expect:
      status: 200
      jsonContains:
        id: "{{genericIntegrationId}}"
        type: "GENERIC"
        name: "{{genericIntegrationName}}"

  # ===== List All Integrations Again =====
  - name: "Verify both integrations exist"
    type: REST
    rest:
      url: "{{BASE_URL}}/api/v1/task-integrations"
      method: GET
      headers:
        Authorization: "Bearer {{accessToken}}"
    expect:
      status: 200

  # ===== Delete JIRA Integration =====
  - name: "Delete JIRA integration"
    type: REST
    rest:
      url: "{{BASE_URL}}/api/v1/task-integrations/{{jiraIntegrationId}}"
      method: DELETE
      headers:
        Authorization: "Bearer {{accessToken}}"
    expect:
      status: 204

  # ===== Verify Deletion =====
  - name: "Verify JIRA integration is deleted"
    type: REST
    rest:
      url: "{{BASE_URL}}/api/v1/task-integrations/{{jiraIntegrationId}}"
      method: GET
      headers:
        Authorization: "Bearer {{accessToken}}"
    continueOnError: true
    expect:
      status: 404

  # ===== Cleanup: Delete GENERIC Integration =====
  - name: "Delete GENERIC integration (cleanup)"
    type: REST
    rest:
      url: "{{BASE_URL}}/api/v1/task-integrations/{{genericIntegrationId}}"
      method: DELETE
      headers:
        Authorization: "Bearer {{accessToken}}"
    continueOnError: true
    expect:
      status: 204
