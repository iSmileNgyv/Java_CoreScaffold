# Release and Version API Tests
# Tests release creation, version recommendation, and listing

env:
  BASE_URL: "http://localhost:8081"

variables:
  testEmail: "release-tester@chronovcs.com"
  testPassword: "test123"
  repoName: "test-release-repo"
  uniqueKey: "{{date:yyyyMMddHHmmss}}"

tests:
  # ===== Setup: Create test user =====
  - name: "Create test user via database"
    type: BASH
    bash:
      command: |
        PGPASSWORD=chronovcs_password psql -h localhost -p 5432 -U chronovcs_user -d chronovcs -c "
        INSERT INTO chronovcs_users (email, password_hash, full_name, created_at, updated_at)
        VALUES (
          '{{testEmail}}',
          '\$2a\$10\$N9qo8uLOickgx2ZMRZoMyeIjZAgcfl7p92ldGxad68LJZdL17lhWy',
          'Release Tester',
          NOW(),
          NOW()
        )
        ON CONFLICT (email) DO NOTHING;
        "
    continueOnError: true
    expect:
      status: 0

  # ===== Authentication =====
  - name: "Login to get access token"
    type: REST
    rest:
      url: "{{BASE_URL}}/api/auth/login"
      method: POST
      headers:
        Content-Type: "application/json"
      body:
        email: "{{testEmail}}"
        password: "{{testPassword}}"
    extract:
      accessToken: "$.accessToken"
    expect:
      status: 200

  # ===== Create Repository =====
  - name: "Create test repository"
    type: REST
    rest:
      url: "{{BASE_URL}}/api/repositories"
      method: POST
      headers:
        Content-Type: "application/json"
        Authorization: "Bearer {{accessToken}}"
      body:
        repoKey: "repo-{{uniqueKey}}"
        repoName: "{{repoName}}"
        description: "Test repository for release testing"
    extract:
      repoKey: "$.repoKey"
    expect:
      status: 200
      jsonContains:
        repoName: "{{repoName}}"

  # ===== Create First Release (Manual Version) =====
  - name: "Create release with manual version 1.0.0"
    type: REST
    rest:
      url: "{{BASE_URL}}/api/repositories/{{repoKey}}/releases"
      method: POST
      headers:
        Content-Type: "application/json"
        Authorization: "Bearer {{accessToken}}"
      body:
        version: "1.0.0"
        message: "Initial release"
    extract:
      release1Id: "$.id"
      release1Version: "$.version"
    expect:
      status: 200
      jsonContains:
        version: "1.0.0"
        message: "Initial release"

  # ===== Get All Releases =====
  - name: "Get all releases for repository"
    type: REST
    rest:
      url: "{{BASE_URL}}/api/repositories/{{repoKey}}/releases"
      method: GET
      headers:
        Authorization: "Bearer {{accessToken}}"
    expect:
      status: 200

  # ===== Create Second Release (Auto PATCH) =====
  - name: "Create release with auto PATCH increment"
    type: REST
    rest:
      url: "{{BASE_URL}}/api/repositories/{{repoKey}}/releases"
      method: POST
      headers:
        Content-Type: "application/json"
        Authorization: "Bearer {{accessToken}}"
      body:
        versionType: "PATCH"
        message: "Bug fixes"
    extract:
      release2Version: "$.version"
    expect:
      status: 200
      jsonContains:
        version: "1.0.1"
        message: "Bug fixes"

  # ===== Create Third Release (Auto MINOR) =====
  - name: "Create release with auto MINOR increment"
    type: REST
    rest:
      url: "{{BASE_URL}}/api/repositories/{{repoKey}}/releases"
      method: POST
      headers:
        Content-Type: "application/json"
        Authorization: "Bearer {{accessToken}}"
      body:
        versionType: "MINOR"
        message: "New features"
    extract:
      release3Version: "$.version"
    expect:
      status: 200
      jsonContains:
        version: "1.1.0"
        message: "New features"

  # ===== Create Fourth Release (Auto MAJOR) =====
  - name: "Create release with auto MAJOR increment"
    type: REST
    rest:
      url: "{{BASE_URL}}/api/repositories/{{repoKey}}/releases"
      method: POST
      headers:
        Content-Type: "application/json"
        Authorization: "Bearer {{accessToken}}"
      body:
        versionType: "MAJOR"
        message: "Breaking changes"
    extract:
      release4Version: "$.version"
    expect:
      status: 200
      jsonContains:
        version: "2.0.0"
        message: "Breaking changes"

  # ===== Verify All Releases Created =====
  - name: "Verify all 4 releases exist"
    type: REST
    rest:
      url: "{{BASE_URL}}/api/repositories/{{repoKey}}/releases"
      method: GET
      headers:
        Authorization: "Bearer {{accessToken}}"
    expect:
      status: 200

  # ===== Test Version Recommendation (Without JIRA) =====
  - name: "Get version recommendation without JIRA tasks"
    type: REST
    rest:
      url: "{{BASE_URL}}/api/repositories/{{repoKey}}/releases/recommend"
      method: GET
      headers:
        Authorization: "Bearer {{accessToken}}"
    extract:
      recommendedVersion: "$.recommendedVersion"
      recommendedType: "$.versionType"
    expect:
      status: 200
      jsonContains:
        currentVersion: "2.0.0"

  # ===== Summary =====
  - name: "Print test summary"
    type: BASH
    bash:
      command: |
        echo "========================================="
        echo "Release Testing Summary"
        echo "========================================="
        echo "Repository: {{repoKey}}"
        echo "Release 1: {{release1Version}} (Manual)"
        echo "Release 2: {{release2Version}} (PATCH)"
        echo "Release 3: {{release3Version}} (MINOR)"
        echo "Release 4: {{release4Version}} (MAJOR)"
        echo "Recommended: {{recommendedVersion}} ({{recommendedType}})"
        echo "========================================="
    expect:
      status: 0
